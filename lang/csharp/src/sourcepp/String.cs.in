using System.Collections.Generic;
using System.Runtime.InteropServices;

/*
 * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 *
 *                        DO NOT EDIT THIS FILE
 *                         IT IS AUTOGENERATED
 *                             THANK YOU
 *
 * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 */

namespace ${TARGET}.sourcepp
{
    internal static unsafe partial class Extern
    {
        [LibraryImport("sourcepp_${TARGET}c", EntryPoint = "sourcepp_string_new")]
        public static partial String StringNew(ulong size);

        [LibraryImport("sourcepp_${TARGET}c", EntryPoint = "sourcepp_string_free")]
        public static partial void StringFree(String* str);

        [LibraryImport("sourcepp_${TARGET}c", EntryPoint = "sourcepp_string_array_new")]
        public static partial StringArray StringArrayNew(ulong size);

        [LibraryImport("sourcepp_${TARGET}c", EntryPoint = "sourcepp_string_array_free")]
        public static partial void StringArrayFree(StringArray* array);
    }

    [StructLayout(LayoutKind.Sequential)]
    internal struct String
    {
        public long size;
        public unsafe sbyte* data;
    }

    [StructLayout(LayoutKind.Sequential)]
    internal struct StringArray
    {
        public long size;
        public unsafe sbyte** data;
    }

    internal static unsafe class StringUtils
    {
        public static string ConvertToStringAndDelete(ref String str)
        {
            var result = new string(str.data);

            fixed (String* strPtr = &str)
            {
                Extern.StringFree(strPtr);
            }

            return result;
        }

        public static List<string> ConvertToListAndDelete(ref StringArray array)
        {
            var strings = new List<string>();

            for (long i = 0; i < array.size; i++)
            {
                strings.Add(new string(array.data[i]));
            }

            fixed (StringArray* arrayPtr = &array)
            {
                Extern.StringArrayFree(arrayPtr);
            }

            return strings;
        }
    }
}
